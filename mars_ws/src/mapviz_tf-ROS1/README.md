## The installation and running steps have been automated as of March 2020 using scripts in the `mapviz_tf/scripts` folder. 
* Run `setup_docker.sh` if this is the first time using the map server on this computer. This requires that you restart your 
machine
* The master GUI should use `pre-launch.sh` to run the server
* The master GUI will already have a `roscore` so after running pre-launch, it can go ahead and launch `mapviz`
* When closing mapviz, run `shutdown_server.sh`
* `.mapviz_config` is copied into the home directory from this package on launch. This means that any changes made to the 
config that you want to keep will need to be saved after running by copying the contents of the home directory config into
this package's config before running the scripts again
* The installation and running steps below are being kept for reference

## Installation
Install `docker` and `docker.io`:
```
sudo apt install docker
sudo apt install docker.io
````

## Running the Map GUI
1. Make sure a `roscore` is running.
1. On the base laptop, open a new terminal and run the command `map_server`. This is an alias for the following commands: 
    ```
    sudo docker stop $(sudo docker ps -aq)
    sudo docker rm $(sudo docker ps -aq)
    sudo docker run -p 8080:8080 -t -v ~/mapproxy:/mapproxy danielsnider/mapproxy
    ```
    The last command is the important one; it starts a local map server. The first two are only necessary in order to be able to repeatedly launch, close, and relaunch the server without any problems. 

    You can go to [http://127.0.0.1:8080/demo/](http://127.0.0.1:8080/demo/) to make sure the local map server is working.

    **Note**: When you run it on a particular machine for the first time, you must be connected to the internet. What's awesome about this is if you load the tile even once, it's cached on your device for offline use. 
1. In a new terminal, run `mapviz` (alias for `roslaunch mapviz_tf mapviz.launch`). A mapviz window should show up.

    If you need to change the origin location (Hanksville, BYU, others), you will need to edit `mapviz.launch` and change two values. The first value is for`local_xy_origin`: change it to the name of your desired location, which can be found as a list of locations within the `local_xy_origins` parameter. The second value is `map_origin_index`: change this value to the index that points to your desired location in the `local_xy_origins` list. For example, choosing the first location (BYU) would require a value of 0.

    **Note: if mapviz is already set up on the machine you are using, then you can skip steps 4-5.**
1. Within mapviz, on the left side, select `Add` to add a new display and choose `tile_map`. Change the source to Custom WMTS Source...
1. Set the Base URL as `http://localhost:8080/wmts/gm_layer/gm_grid/{level}/{x}/{y}.png` and the Max Zoom to `19`. You can save it and give it a name to go back to it later.
1. The map should be coming up now. If not, you may not be connected to the internet or the map isn't cached on your device.

### Plugins to add (for first-time setup or if mapviz gets screwed up)
Add a `robot_image` by selecting `Add` and choosing `robot_image`. This will allow you to view the rover's position and heading in real time. We've been using the turtle image found in the repo under `BYU-Mars-Rover/gui_plugin_ws/src/mapviz_tf/image/Rover.png`. You should have `gps_imu` being published before you run mapviz in order for this to work (run `roslaunch navigation ins.launch` for the `gps_imu` topic).

A `point_click_publisher` will publish in a certain reference frame a PointStamped message wherever you click within the map. You can set this reference frame to `origin` to get a reference from the local origin, or you can set the frame to `/wgs84` to get a gps coordinate out of the `point_click_publisher`.

You also add a `path`, to show the planned route. This works with the `path_planning` package. The `path` plugin will plot the path that has been generated by `path_planning` package using `A* algorithm`.

### Caching maps
Simplest way is to view all areas in mapviz that you want to be cached at as many zoom levels as possible. 

Also, there are scripts in the `scripts` directory that cache maps for locations. The scripts is to cache maps at BYU and for Hanksville. The scripts cache a 20km square of tiles, 10km in each direction from the origin. The scripts will take a while to run because they're making over 10000 requests to Google's servers, but the mapproxy caches whatever tiles you pull down.

The `setup_cache.sh` file could take more than two hours to run if there is no cache established. 
